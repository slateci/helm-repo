# Kubernetes Endpoint Helm Chart
This chart will deploy a functioning Kubernetes endpoint into your cluster. It
will launch workers with a specified container image into a namespace.

It uses Role Based Access Control to create a service account and assign it
permissions to create the worker pod.

## How to Use
There are two required values to specify in the `values.yaml` file:
`endpointUUID` and authentication.  The `endpointUUID` is easy:

```
endpointUUID: <someuuid>
```

The UUID is of your choosing, but must be available.  In particular, if the
UUID you choose has already been taken, the endpoint will fail to register.
One method to generate a UUID is with the `uuid` command line tool:

```shell
$ sudo apt install uuid
...
$ uuid  # will generate a version 1 UUID.
e22be136-b3eb-11ed-8611-5b7bc2d2f962
```

Alternatively, Python has the builtin `uuid` module:
```python
>>> import uuid
>>> uuid.uuid4()
UUID('ea0cab7e-b3eb-11ed-ae8b-719a5541eacb')
```

Getting the authentication setup is slightly more involved.  Under the hood,
the funcX Endpoint uses the funcX SDK for communication with the web services,
which requires an authenticated user for most API routes.  The funcX SDK can
use either client credentials or user credentials, both of which this chart
implements.  The next two sections describe how to implement each.

#### Client Credentials
The funcX SDK supports use of Globus Auth Client Credentials.  In practice,
that means exporting two variables into the endpoint's environment:

* `FUNCX_SDK_CLIENT_ID`
* `FUNCX_SDK_CLIENT_SECRET`

These variables may be generated by following the steps in the [Registering an
Application](https://docs.globus.org/api/auth/developer-guide/#register-app)
section on the [Globus Auth Developer's
Guide](https://docs.globus.org/api/auth/developer-guide/).

Outside of this chart, use of client credentials is also documented for [normal
funcX SDK
usage](https://funcx.readthedocs.io/en/latest/sdk.html#client-credentials-with-funcxclients).

Add these variables to a secret object in SLATE.  For example, to put them
into a Kubernetes store named `my-secrets`, you could create a temporary env file
and load them:

```
$ (umask 077; touch client_creds.env)  # create with 0600 (-rw-------) perms
$ cat > client_creds.env
FUNCX_SDK_CLIENT_ID=11111111-2222-4444-8888-000000000000
FUNCX_SDK_CLIENT_SECRET=yoursecret
^D
$ slate secret create --group my-group --cluster cluster1 my-secrets --from-env-file ./client_creds.env
```

Then, specify the secret name in the values file, and tell the chart to use
the client credentials:
```
secrets: my-secrets
useClientCredentials: true
```

#### User Credentials
If you have previously utilized the funcX client, then jump to step 2 as you
will already have generated the credential file.

1. Instantiate a client with these two commands:
    ```shell
    $ pip install funcx
    $ python -c "from funcx import FuncXClient; FuncXClient()"
    ```
    A prompt beginning "Please authenticate with Globus here:" and with a long
    URL to a Globus authentication workflow will print to the terminal; follow
    the URL and paste the resulting token back into the terminal.  This will
    create the credential file at `$HOME/.funcx/storage.db`.
1. Create a Kubernetes secret named `funcx-sdk-tokens` with this file:
    ```shell
    $ kubectl create secret generic funcx-sdk-tokens --from-file=$HOME/.funcx/storage.db
    ```
    It is important to name the secret `funcx-sdk-tokens` as this chart looks
    for that secret name, specifically.

With the `funcx-sdk-tokens` Kubernetes secret object created, tell the chart to
use the user credentials:

```
useUserCredentials: true
```

### Install the helm chart
You need to add the funcx helm chart repo to your helm

```shell script
helm repo add funcx http://funcx.org/funcx-helm-charts/ && helm repo update
```

Create a local values.yaml file to set any specific values you wish to
override. Then invoke the chart installation by specifying your custom values,
the funcx helm repo to install from, and the funcx-endpoint chart:

```shell script
helm install -f your-values.yaml funcx funcx/funcx_endpoint
```

The notes that are printed with the installation will tell you how to access the
logs for the endpoint to see the UID. For example, to retrieve the pod name use
the following command:

```shell script
export EP_POD_NAME=$(kubectl get pods --namespace default -l "app=funcx-endpoint" -o jsonpath="{.items[0].metadata.name}")
```

---
**NOTE**

Depending on your configuration, the namespace may be something other than
'default'.

---

And view the pod's status via:

```shell script
kubectl get pods $EP_POD_NAME
```

Or its logs via:

```shell script
kubectl logs $EP_POD_NAME
```

## Values
The deployment is configured via values.yaml file.

| Value | Description | Default |
|-------| ----------- | ------- |
| funcXServiceAddress | URL for the FuncX Webservice. | https://api.funcx.org |
| image.repository | Docker image repository |  funcx/kube-endpoint |
| image.tag | Tag name for the endpoint image | endpoint_helm |
| image.pullPolicy | Pod pull policy for the endpoint image |  Always |
| workerDebug | Log additional information in the worker logs | False |
| workerImage | Docker image to run in the worker pods |  python:3.6-buster |
| workerInit | Command to execute on worker before strating uip | pip install parsl==0.9.0;pip install --force-reinstall funcx>=0.0.2a0 |
| workerNamespace | Kubernetes namespace to launch worker pods into | default |
| workingDir | Directory inside the container where log files are to be stored | /tmp/worker_logs |
| rbacEnabled | Create service account and roles? | true |
| initMem | Initial memory for worker pod | 2000Mi |
| maxMem| Maximum allowed memory for worker pod | 16000Mi |
| initCPU | Initial CPUs to allocate to worker pod | 1 |
| maxCPU | Maximum CPUs to allocate to worker pod | 2 |
| maxBlocks | Maximum number of worker pods to spawn | 100 |
| maxWorkersPerPod | How many workers will be scheduled in each pod | 1 |
| endpointName | (Optional) Specify a name for registration with the funcX web services | The release name (Release.Name) |
| endpointUUID | (Required) Specify a UUID for this endpoint | |
| endpointCLIargs | Any additional command line arguments to give to the `funcx-endpoint` executable | |
| maxIdleTime  | The maximum time to maintain an idle worker. After this time the SimpleStrategy will terminate the idle worker. | 3600 |
| imagePullSecret | The K8s secret to use to deploy worker images. This can refer to an ECR secret. | |
| secrets | Kubernetes secret object in which to find client credential environment variables | |
| useClientCredentials | Whether to use _client_ credentials | false |
| useUserCredentials | Whether to use _user_ credentials (i.e., `storage.db`) | false |
